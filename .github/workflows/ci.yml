name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  docker-build-and-analyze:
    name: Docker Build and Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t mpi-nvidia-ubuntu:latest .

    - name: Check code formatting (clang-format)
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "find lib example tests -type f \( -name '*.cpp' -o -name '*.h' -o -name '*.hpp' -o -name '*.cu' -o -name '*.cuh' \) | xargs clang-format --dry-run --Werror"

    - name: Run static analysis (clang-tidy) on C++ files
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON && find lib example -type f \( -name '*.cpp' \) ! -path '*/external/*' ! -path '*/imgui*' | xargs clang-tidy -p build --warnings-as-errors='*'"

    - name: Build application
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "cmake -B build -DCMAKE_BUILD_TYPE=Release -DCUDA=ON -DCMAKE_EXPORT_COMPILE_COMMANDS=ON && cmake --build build"

    - name: Verify build artifacts
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "ls -lah build/ && ls -lah build/lib/ && ls -lah build/example/"
