name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  docker-build-and-analyze:
    name: Docker Build and Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build Docker image
      run: |
        docker build -t mpi-nvidia-ubuntu:latest .

    - name: Check code formatting (clang-format)
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "find lib example tests -type f \( -name '*.cpp' -o -name '*.h' -o -name '*.hpp' -o -name '*.cu' -o -name '*.cuh' \) | xargs clang-format --dry-run --Werror"

    - name: Run static analysis (clang-tidy) on C++ files
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON && find lib example -type f \( -name '*.cpp' \) ! -path '*/external/*' ! -path '*/imgui*' ! -path '*/gpu/*' ! -name '*CUDA*' | xargs clang-tidy -p build --warnings-as-errors='*'"

    - name: Build application
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "cmake -B build -DCMAKE_BUILD_TYPE=Release -DCUDA=ON -DCMAKE_EXPORT_COMPILE_COMMANDS=ON && cmake --build build"

    - name: Verify build artifacts
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "ls -lah build/ && ls -lah build/lib/ && ls -lah build/example/"

    - name: Run test1 with 2 MPI processes and 2 threads
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "mpirun --allow-run-as-root -np 2 build/bin/test1 2 /tmp/test1.dat && python3 utils/compare_checkpoints.py tests/game-of-life/checkpoints/test1.dat /tmp/test1.dat"

    - name: Run test2 with 2 MPI processes and 2 threads
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "mpirun --allow-run-as-root -np 2 build/bin/test2 2 /tmp/test2.dat && python3 utils/compare_checkpoints.py tests/game-of-life/checkpoints/test2.dat /tmp/test2.dat"

    - name: Run test3 with 2 MPI processes and 2 threads
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "mpirun --allow-run-as-root -np 2 build/bin/test3 2 /tmp/test3.dat && python3 utils/compare_checkpoints.py tests/game-of-life/checkpoints/test3.dat /tmp/test3.dat"

    - name: Run test4 with 2 MPI processes and 4 threads
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "mpirun --allow-run-as-root -np 2 build/bin/test4 4 /tmp/test4.dat && python3 utils/compare_checkpoints.py tests/game-of-life/checkpoints/test4.dat /tmp/test4.dat"

    - name: Run test5 with 2 MPI processes and 2 threads
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          mpi-nvidia-ubuntu:latest \
          bash -c "mpirun --allow-run-as-root -np 2 build/bin/test5 2 /tmp/test5.dat && python3 utils/compare_checkpoints.py tests/game-of-life/checkpoints/test5.dat /tmp/test5.dat"
